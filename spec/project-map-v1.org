#+title: Карта проекта Carriage-mode v1
#+language: ru
#+options: toc:2 num:t
#+property: header-args :results silent

* Назначение
- Этот документ дополняет spec/project-structure-v1.org и даёт обзор-«карту» проекта:
  - Полный список файлов исходников (lisp/*) с краткими описаниями и ключевыми функциями/точками расширения.
  - Свод правил структурирования проекта (слои, зависимые модули, именование, provide).
  - Указатели на ключевые спецификации в каталоге spec/.

* Свод правил структурирования (резюме)
- Слои и зависимости (сверху вниз запрещено):
  - Core: errors → logging → utils → git
  - Domain: parser → apply → report
  - Mode/UI: ui → iteration → mode → entry (carriage.el)
  - Engines: lisp/engines/* — зависят от logging/utils/git, не от UI
  - Transports: lisp/transports/* — зависят от logging/utils, не от UI
- Директории:
  - lisp/ — код; engines/ — движки; transports/ — адаптеры LLM; ops/ — форматы (:op).
  - spec/ — спецификации форматов, пайплайна и UI.
- Именование и provide:
  - Имена с префиксом carriage-…; внутренние хелперы: carriage--…; (provide 'carriage-…).
- Регистры/реестры:
  - Форматов: carriage-format-registry (parse/dry-run/apply/prompt-fragment).
  - Интентов: carriage-intent-registry.
  - Моделей/бэкендов: carriage-llm-registry.
  - Движков применения: carriage-apply-engine (+ реализации в engines/*).
- Контракты:
  - Все парсеры возвращают alist/plist план-элементы согласно spec/data-structures-v1.org.
  - apply/dry-run — чистые отчёты; синхронные «обёртки» поверх async — допустимы.
- Безопасность:
  - Пути — только относительные внутри корня; TRAMP — запрещён (v1).
  - Бинарные патчи — запрещены в v1 (см. spec/security-v1.org).
- UI:
  - Клавиши через keyspec (lisp/carriage-keyspec.el); глобальный префикс — carriage-global-mode.

* Карта исходников (lisp/*)

** Core (базовые подсистемы)
- lisp/carriage-errors.el
  - Назначение: таблица ошибок и define-error.
  - Ключевые: carriage-define-errors, carriage-error-symbol, carriage-error-message.
- lisp/carriage-logging.el
  - Журналы (*carriage-log*, *carriage-traffic*), показ в сайд-окнах, спец-режим carriage-aux-mode.
  - Ключевые: carriage-log, carriage-traffic-log, carriage-show-log, carriage-show-traffic.
- lisp/carriage-utils.el
  - Утилиты: корень проекта, нормализация путей, вызовы git (sync), I/O файлов, генерация DELIM.
  - Ключевые: carriage-project-root, carriage-normalize-path, carriage--call-git, carriage-generate-delim.
- lisp/carriage-git.el
  - Git-хелперы (sync + async) и веточные политики (WIP/ephemeral).
  - Ключевые (async): carriage-git-ensure-repo-async, carriage-git-checkout-wip-async,
    carriage-git-create-ephemeral-branch-async, carriage-git-switch-branch-async,
    carriage-git-delete-branch-async, carriage-git-branches-diff-empty-async.
  - Ключевые (sync): carriage-git-add, carriage-git-commit, carriage-git-mv, carriage-git-rm, carriage-git-reset-soft.

** Реестры и билдеры
- lisp/carriage-format-registry.el
  - Реестр парсеров/апплаеров: (:op,:version) → (:parse :dry-run :apply :prompt-fragment).
  - Ключевые: carriage-format-register, carriage-format-get, carriage-format-ops.
- lisp/carriage-intent-registry.el
  - Реестр фрагментов Intent (Ask|Code|Hybrid).
  - Ключевые: carriage-intent-register, carriage-intent-get, carriage-intent-known.
- lisp/carriage-llm-registry.el
  - Реестр бэкендов/моделей LLM; кандидаты выбора; нормализация id.
  - Ключевые: carriage-llm-register-backend, carriage-llm-available-models,
    carriage-llm-candidates, carriage-llm-default-candidate, carriage-llm-make-full-id.
- lisp/carriage-suite.el
  - Suite builder: композиция системного промпта из фрагментов ops и intent, белые списки :ops-allowed.
  - Ключевые: carriage-suite-ops, carriage-suite-ids, carriage-build-prompt.

** Форматы (ops/*) — парсеры/апплаеры
- lisp/ops/carriage-op-sre.el
  - SRE v1: пары begin_from/begin_to (+ #+pair). Dry-run/симуляция, мини-диффы, apply.
  - Ключевые: carriage-parse-sre, carriage-dry-run-sre, carriage-apply-sre.
- lisp/ops/carriage-op-aibo.el
  - AIBO v1: literal-only S/R, запрет :match; делегирует в SRE-ядро.
  - Ключевые: carriage-parse-aibo, carriage-dry-run-aibo, carriage-apply-aibo.
- lisp/ops/carriage-op-patch.el
  - Unified diff v1 (один файл), валидация :strip, binary/rename/copy guards.
  - Ключевые: carriage-parse-diff (+ вспом. валидаторы).
- lisp/ops/carriage-op-file.el
  - File ops: create/delete/rename (парсер, dry-run, apply).
  - Ключевые: carriage-parse-create, carriage-parse-delete, carriage-parse-rename,
    carriage-dry-run-create, carriage-apply-create, carriage-apply-delete, carriage-apply-rename.
- lisp/carriage-sre-core.el
  - Общие хелперы SRE (в т.ч. загрузка carriage-sre-delim).
- (Удалено в v1.1) — модуль перепрошивки DELIM не требуется: :op create использует «сырой» контент тела блока.

** Пайплайн применения
- lisp/carriage-apply.el
  - Порядок и группировка план-элементов; dry-run/apply отчёты; асинхронный FSM, веточные политики git.
  - Ключевые:
    - Сортировка и отчёты: carriage-dry-run-plan, carriage-apply-plan.
    - Async FSM: carriage-apply-plan-async (+ внутренние carriage--apply-…).
    - Движок → рядок отчёта: carriage--engine-row.
- lisp/engines/carriage-apply-engine.el
  - Реестр движков, выбор активного, диспетчеризация :dry-run/:apply с проверкой capabilities.
  - Ключевые: carriage-register-apply-engine, carriage-apply-engine, carriage-apply-engine-dispatch,
    carriage-select-apply-engine.
- lisp/engines/carriage-engine-git.el
  - Движок 'git: async процессы (git apply/--check, add/rm/mv), таймауты/abort.
  - Ключевые: carriage-engine-git-dry-run, carriage-engine-git-apply, carriage-engine-git-abort.
- lisp/engines/carriage-engine-emacs.el
  - Движок 'emacs: локальные операции (create/delete/rename/sre/aibo); patch в v1 не поддерживается (capabilities).
  - Ключевые: carriage-engine-emacs-dry-run, carriage-engine-emacs-apply, carriage-engine-emacs-capabilities.

** Транспорт LLM (streaming)
- lisp/transports/carriage-transport.el
  - Диспетчер транспорта: begin/streaming/complete, ленивые подгрузки адаптеров.
  - Ключевые: carriage-transport-begin, carriage-transport-streaming, carriage-transport-complete,
    carriage-transport-dispatch.
- lisp/transports/carriage-transport-gptel.el
  - Адаптер к gptel: потоковые события, reasoning, abort, вставка чанков через UI API.
  - Ключевые: carriage-transport-gptel-dispatch (+ внутренний классификатор событий).
- lisp/transports/carriage-transport-echo.el
  - Echo-демо адаптер (dev): имитация стрима; удобен для отладки.

** UI/Mode/Report/Context
- lisp/carriage-ui.el
  - Header-line (project › buffer › outline), mode-line (иконки/кнопки/спиннер), эффекты (flash/звук).
  - Ключевые: carriage-ui-set-state, carriage-ui--modeline, carriage-ui--header-line,
    carriage-ui--flash-last-iteration-patches.
- lisp/carriage-mode.el
  - Минор-режим, публичные команды, интеграция всего: отправка/приём/применение, тумблеры, preloader.
  - Ключевые команды: carriage-mode, carriage-send-buffer, carriage-send-subtree,
    carriage-dry-run-at-point, carriage-apply-at-point-or-region, carriage-apply-last-iteration,
    carriage-select-suite, carriage-select-model, carriage-select-backend, carriage-select-apply-engine,
    carriage-commit-changes, carriage-commit-last-iteration, carriage-abort-current, carriage-open-buffer.
- lisp/carriage-keyspec.el
  - Централизованная модель биндингов по контекстам; генерация transient/which-key.
  - Ключевые: carriage-keys-apply-known-keymaps, carriage-keys-open-menu, carriage-keys-lint-collisions.
- lisp/carriage-global-mode.el
  - Глобальный префикс C-c e вне carriage-mode; связывает меню/префикс с контекстом global.
- lisp/carriage-report.el
  - Буфер отчёта (org-table), кнопки действий, Ediff/preview.
  - Ключевые: carriage-report-open, carriage-report-render, carriage-report-apply-at-point,
    carriage-report-show-diff-at-point, carriage-report-ediff-at-point.
- lisp/carriage-context.el
  - Сбор и форматирование контекста (gptel-context + #+begin_context).
  - Ключевые: carriage-context-collect, carriage-context-format.
- lisp/carriage-i18n.el
  - Слой локализации (ru/en) для UI/which-key/transient.
  - Ключевые: carriage-i18n, carriage-i18n-set-locale.
- lisp/carriage-iteration.el
  - Маркировка/чтение «последней итерации» (inline marker + text properties).
  - Ключевые: carriage-mark-last-iteration, carriage-current-iteration-id, carriage-begin-iteration.
- lisp/carriage-announce.el
  - Дружественные сообщения об успешном применении (hook поверх отчёта).
- lisp/carriage-parser.el
  - Диспетчер парсинга блока под точкой/в регионе; ленивые подгрузки ops-модулей.
  - Ключевые: carriage-parse-block-at-point, carriage-parse-blocks-in-region, carriage-parse.

** Входная точка
- lisp/carriage.el
  - Entry point; инициализирует ошибки/пути, подключает ключевые подсистемы и регистры; добавляет ops/transports/engines в load-path.
  - Ключевое: (carriage-define-errors), require основных модулей.

* Указатели на спецификации (spec/* — основные)
- spec/index.org — индекс спецификаций и FREEZE (лимиты).
- spec/project-structure-v1.org — структура слоёв/директорий/правила (источник истины).
- spec/apply-engines-v1.org — абстракция движков применения.
- spec/apply-pipeline-v1.org — конвейер dry-run/подтверждение/apply.
- spec/patch-unified-diff-v1.org — unified diff (v1).
- spec/sre-v1.org — SRE (begin_from/begin_to).
- spec/aibo-v1.org — AIBO (literal-only S/R).
- spec/file-ops-v1.org — create/delete/rename.
- spec/security-v1.org — политика безопасности (пути/TRAMP/EOL).
- spec/errors-v1.org — коды ошибок и таблицы.
- spec/ui-v1.org — header-line/mode-line/меню/отчёты.
- spec/llm-transport-v1.org — абстракция транспорта (gptel-адаптер).
- spec/context-integration-v1.org — контекст (gptel + документальные блоки).
- spec/keyspec-v1.org — централизованная модель клавиш.
- spec/testing-v1.org — план тестов (юниты/интеграция), голден-файлы.
- spec/compliance-checklist-v1.org — чек-лист соответствия.

* Точки расширения (как найти место для доработки)
- Новый формат (:op): создать lisp/ops/carriage-op-<op>.el, зарегистрировать parse/dry-run/apply, добавить prompt-fragment; обновить suite overlays при необходимости.
- Новый движок применения: lisp/engines/carriage-engine-<name>.el; зарегистрировать через carriage-register-apply-engine; указать capabilities.
- Новый транспорт: lisp/transports/carriage-transport-<backend>.el; предоставить entry-point carriage-transport-<backend>-dispatch.
- Новые действия/клавиши: добавить запись в carriage-keyspec (:id :cmd :keys :contexts …); i18n — через carriage-i18n.el.
- Новые UI компоненты: расширять carriage-ui.el (header-line/modeline) или дочерние спец-буферы; соблюдать буферную локальность и i18n-ключи.

* Примечания по навигации кода
- Быстрый поиск «источника истины»: сначала смотреть спецификацию в spec/*, затем реализацию в lisp/*.
- Для основного сценария dry-run/apply:
  1) carriage-parser.el → (parse блоков) → план
  2) carriage-apply.el → (dry-run/async FSM) → отчёт
  3) engines/* → git/emacs шаги
  4) report/ui → визуализация и действия
- Для стриминга LLM:
  1) carriage-mode.el (send-buffer/subtree) → carriage-transport-begin → carriage-transport-*-dispatch
  2) carriage-transport-*.el → события (text/reasoning/done/abort)
  3) carriage-ui.el → вставка чанков, спиннер, финализация/flash/звук.

