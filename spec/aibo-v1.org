#+title: AIBO v1 — Literal-only Search/Replace
#+author: Carriage Team
#+language: ru
#+options: toc:2 num:t
#+property: header-args :results silent

* Назначение и охват
- AIBO — «жёсткий» формат поисково-заменяющих патчей без регулярок.
- Цель: максимальная надёжность генерации слабой моделью и идемпотентность за счёт якорей/диапазонов.
- Версия спецификации: "1" (v1).

* Термины
- Блок patch: #+begin_patch (<plist>) … #+end_patch
- FROM/TO — спецблоки: #+begin_from … #+end_from, #+begin_to … #+end_to
- Пара (pair) — последовательные FROM→TO.

* Заголовок
- #+begin_patch (:version "1" :op "aibo" :file "relative/path")
- #+end_patch

Ключи:
- :version — "1"
- :op — "aibo"
- :file — относительный путь внутри корня проекта

* Тело блока
- Директива пары (опционально): "#+pair (<plist>)" — для СЛЕДУЮЩЕЙ пары
- FROM/TO пары (строго попарно и последовательно)

Дефолты опций пары:
- :occur first
- :range отсутствует
- Регулярные выражения запрещены (ключ :match не допускается)

Допустимые опции пары:
- :occur 'first | 'all  ; при :occur 'all обязателен :expect ≥ 0
- :expect INTEGER≥0
- :range (:start-line N :end-line M) — включительно
- :anchor 'bos|'eos|'bol|'eol — привязка начала/конца файла/строки (на усмотрение реализации)

* Семантика и ограничения
- Поиск — только точная подстрока (literal); экранирование не требуется.
- Идемпотентность: один проход; пара видит изменения предыдущих пар.
- NOOP-политика: если итоговый текст after байт-в-байт равен before, шаг помечается 'skip, отчёт содержит :matches и :changed-bytes=0.

* Парсинг (норматив)
- Те же правила извлечения пар/директив, что и в SRE v1 (без :match).
- Ошибки:
  - SRE_E_SEGMENTS_COUNT — нет ни одной пары
  - SRE_E_UNPAIRED — from без последующего to
  - SRE_E_UNCLOSED_BLOCK — незакрытый блок FROM/TO
  - SRE_E_OCCUR_EXPECT — :occur all без :expect
  - SRE_E_OCCUR_VALUE — любое значение :occur, отличное от 'first|'all
  - SRE_E_EMPTY_SEGMENT — пустой FROM или TO (ровно пустая строка)

* Dry-run
- Подсчитать :matches с учётом :occur/:range; подготовить мини-дифф (опционально).
- Отчётный item: :matches, :diff?, :changed-bytes (рассчитан по симуляции), :status 'ok|'fail|'skip.

* Применение
- Переписать файл текстом after; при policy='index — проиндексировать.
- При after==before — статус 'skip (NOOP).

* Безопасность и лимиты
- Пути/лимиты/EOL — см. ./security-v1.org и ./index.org (FREEZE).
- TRAMP/remote — запрещено в v1.

* Имя спец-блока
- Только begin_patch/end_patch — см. ./parser-registry-v1.org.
