#+title: Apply Pipeline v1
#+author: Peter Kosov <11111000000@email.com>
#+language: ru
#+options: toc:2 num:t

* Цель
- Нормативный конвейер применения патчей: dry-run → предпросмотр → подтверждение → применение (коммит — отдельное действие).

* Порядок и группировка
- C-c C-c — применяется один блок под точкой.
- C-c ! — применяются все блоки «последней итерации» как группа:
  - Остановка на первой ошибке.
  - Автоматический откат частичных изменений в v1 не выполняется.
- Упорядочение по типам операций:
  1) delete
  2) rename
  3) create
  4) patch
  5) sre
- Внутри одного типа — в порядке появления в ответе.
- Конфликты по пути:
  - Если и create, и sre касаются одного файла — create → затем sre.
  - Если rename и sre — rename → затем sre (с новым путём).

* Dry-run (общие правила)
- Для каждого блока рассчитывается применимость:
  - SRE: число совпадений, соблюдение :expect, мини-дифф.
  - Patch: git apply --check, сбор stdout/stderr.
- Если блок не применим — группа не стартует; отчёт показывает причину.

* Применение
- Все шаги выполняются через активный движок применения (см. ./apply-engines-v1.org); шаги неблокирующие, переход между шагами — по событиям завершения (sentinel/колбэки).
- Синхронная обёртка допустима для одиночных применений (например, C-c C-c) как блокирующий адаптер над движком; основным путём остаётся асинхронный.
- SRE: переписывание целевого файла; индексация по политике стадирования (carriage-apply-stage-policy), по умолчанию — без индексации.
- Patch: по умолчанию 'git-движок выполняет git apply (или git apply --index при policy='index); без коммита.
- Наблюдаемость: каждый вызов движка (check/apply/add/mv/rm/reset) логируется в *carriage-log* (begin/exec/pid/exit/timeout). Команд git commit в пайплайне применения нет.
- Коммиты — отдельные команды:
  - Пользователь выполняет их после правок (например, carriage-commit-changes или carriage-commit-last-iteration).
  - Политика по умолчанию — не коммитить автоматически; промпт не управляет коммитами.

* Отчёты и подтверждение
- Отчет dry-run: список блоков, статус, подсказки.
- Подтверждение перед применением: да/нет, с возможностью раскрыть diff/ediff.

* Откат
- В v1 автоматический откат не выполняется; группа останавливается на первой ошибке.
- Пользователь может выполнить откат вручную (soft reset) через команды UI (см. git-integration/ui).

* Идемпотентность и повторное применение
- При повторном apply на уже изменённый файл:
  - SRE/AIBO: 0 совпадений → отказ (по умолчанию) или 'skip по политике (carriage-mode-sre-noop-on-zero-matches=t).
  - SRE/AIBO: if after==before (симуляция даёт тот же текст) → 'skip (NOOP), отчёт включает :matches и :changed-bytes=0.
  - Patch: git apply --check даст отказ — блок пропускается с сообщением (добавить PATCH_E_GIT_CHECK в :messages).

* Ограничения
- Бинарные патчи (patch) — отказ.
- Файлы вне репо — отказ.
- TRAMP — для v1 не поддерживается.
