#+title: Apply Pipeline v1
#+author: Peter Kosov <11111000000@email.com>
#+language: ru
#+options: toc:2 num:t

* Цель
- Нормативный конвейер применения патчей: dry-run → предпросмотр → подтверждение → применение → коммит.

* Порядок и группировка
- C-c C-c — применяется один блок под точкой.
- C-c ! — применяются все блоки «последней итерации» как группа:
  - Остановка на первой ошибке.
  - Автоматический откат частичных изменений в v1 не выполняется.
- Упорядочение по типам операций:
  1) delete
  2) rename
  3) create
  4) patch
  5) sre/sre-batch
- Внутри одного типа — в порядке появления в ответе.
- Конфликты по пути:
  - Если и create, и sre касаются одного файла — create → затем sre.
  - Если rename и sre — rename → затем sre (с новым путём).

* Dry-run (общие правила)
- Для каждого блока рассчитывается применимость:
  - SRE: число совпадений, соблюдение :expect, мини-дифф.
  - Patch: git apply --check, сбор stdout/stderr.
- Если блок не применим — группа не стартует; отчёт показывает причину.

* Применение
- SRE: переписывание целевого файла, git add.
- Patch: git apply --index, затем git add (кроме /dev/null).
- Коммиты:
  - По умолчанию — один коммит на блок, сообщение: "carriage: {op} {file|path}".
  - Опция squash: один коммит на всю группу.

* Отчёты и подтверждение
- Отчет dry-run: список блоков, статус, подсказки.
- Подтверждение перед применением: да/нет, с возможностью раскрыть diff/ediff.

* Откат
- В v1 автоматический откат не выполняется; группа останавливается на первой ошибке.
- Пользователь может выполнить откат вручную (soft reset) через команды UI (см. git-integration/ui).

* Идемпотентность и повторное применение
- При повторном apply на уже изменённый файл:
  - SRE-first: 0 совпадений → отказ (по умолчанию); если carriage-mode-sre-noop-on-zero-matches=t — статус 'skip с предупреждением.
  - Patch: git apply --check даст отказ — блок пропускается с сообщением (добавить PATCH_E_GIT_CHECK в :messages).

* Ограничения
- Бинарные патчи (patch) — отказ.
- Файлы вне репо — отказ.
- TRAMP — для v1 не поддерживается.
