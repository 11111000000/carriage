#+title: File header format (File header) v1
#+author: Carriage Team
#+language: en
#+options: toc:2 num:t

* Purpose
This document defines the normative file-header format for source files in the
Carriage-mode project. The header is intended for both humans and simple tools:
- a short description of the module (Emacs/MELPA-style file header);
- metadata (Author, URL, Package-Requires, Version, Keywords, etc.);
- an explicit list of relevant specifications using relative paths (for example: spec/foo.org).

* General requirements
- The specification file is an Org document: spec/file-header-format-v1.org.
- The file header must appear at the very top of the source file (before any code),
  following the Emacs Lisp file header style (see the Emacs Lisp Manual and MELPA conventions).
- An additional block "Specifications:" — a textual list of relative paths to
  specifications (spec/*.org) — must be present in the header and be readable by
  both humans and simple scripts (grep/awk).
- Alternative placement: the same lines may be put at the start of the Commentary
  section, but preference is given to a compact dedicated list under the
  "Specifications:" heading.
- Mandatory specifications (must be listed in every .el file):
  - spec/code-style-v1.org
  - spec/index.org
  - spec/errors-v1.org
  - spec/compliance-checklist-v1.org

* "Specifications" block format
- Each line contains one relative path starting with "spec/". Example:

;; Specifications:
;;   spec/code-style-v1.org
;;   spec/index.org
;;   spec/errors-v1.org
;;   spec/compliance-checklist-v1.org
;;   spec/some-other-relevant-spec.org

- The four mandatory specs listed above are required.
- Additional specifications should be added as appropriate (for example,
  spec/sre-v1.org for SRE parser modules).

* Example header (Emacs Lisp module)
Below is the recommended minimal template to insert at the top of every
Emacs Lisp source file in the project.

;;; my-module.el --- Short description -*- lexical-binding: t; -*-
;;
;; Copyright (C) 2025 Peter Kosov
;; Author: Peter Kosov <email@example.org>
;; URL: https://gnu-emacs.ru
;; Package-Requires: ((emacs "27.1") (cl-lib "0.5"))
;; Version: 0.1
;; Keywords: convenience, tools
;;
;; Specifications:
;;   spec/code-style-v1.org
;;   spec/index.org
;;   spec/errors-v1.org
;;   spec/compliance-checklist-v1.org
;;   spec/carriage-mode-v1.org          ; example of an additional relevant spec
;;
;;; Commentary:
;; A short explanation of the module (one or two sentences).
;;
;;; Code:
;; ... implementation ...
;;
;;; my-module.el ends here

Notes:
- The lines in the "Specifications:" block should be comments in the same style
  as the header (for elisp, use ";;").
- The "Specifications:" block can span any number of lines.
- Comments following the list are allowed — place them in Commentary as usual.

* Guidance for mapping modules to specifications
- Core modules (errors, logging, utils, git):
  - consider spec/git-integration-v1.org, spec/async-workflow-v1.org, spec/security-v1.org, etc.
- Parsers / ops:
  - spec/sre-v1.org, spec/patch-unified-diff-v1.org, spec/file-ops-v1.org, spec/parser-impl-v1.org
- UI / Mode:
  - spec/ui-v1.org, spec/keyspec-v1.org, spec/i18n-v1.org, spec/context-integration-v1.org
- Transports / LLM:
  - spec/llm-transport-v1.org, spec/logging-v1.org
- Testing / profiles:
  - spec/testing-v1.org, spec/compliance-checklist-v1.org

(The full mapping of modules → specifications will be prepared separately and
applied via batch patching of source files.)

* Machine and human processing
- Simple scripts (tools/add-spec-headers.sh, CI linters) may inspect the first
  ~200 lines and locate the "Specifications:" block using a simple regexp:
  ^;;\s+Specifications:\s*$  → then collect subsequent comment lines of the form:
  ;;\s+spec/...
- Missing or empty lists should be treated as a compliance issue and reported
  by the CI checks.

* Migration and maintenance
- When a new relevant specification appears:
  - update headers of impacted files;
  - open a PR describing why modules fall under the new spec.
- New files must include the header; CI may enforce this with a linter.

* Short examples of mappings
- lisp/carriage-apply.el → spec/apply-pipeline-v1.org, spec/apply-engines-v1.org, spec/git-integration-v1.org
- lisp/carriage-sre-core.el → spec/sre-v1.org, spec/parser-impl-v1.org
- lisp/carriage-transport-gptel.el → spec/llm-transport-v1.org, spec/logging-v1.org

* Conclusion
This document establishes a single formal practice: include a standard Emacs
file header plus a "Specifications" list. The next step is to add these headers
to all source files in the repository as a batch change.
