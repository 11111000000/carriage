#+title: Task Docs v1 — Создание задач из заголовков Org
#+author: Carriage Team
#+language: ru
#+options: toc:2 num:t
#+property: header-args :results silent

* Назначение
- Команда carriage-create-task-doc создаёт отдельный документ задачи из текущего заголовка org.
- Цель: быстрый цикл фиксации задачи, переноса контента и запуска анализа (Intent=Ask).

* Поведение
- Заголовок: берётся из текущего org-заголовка (или запрашивается).
- Нумерация:
  - Имя файла: "N.0-<slug>.org", где N — следующий целый номер среди соседей.
  - Соседи: файлы, удовлетворяющие шаблону "^[0-9]+\\(\\.[0-9]+\\)?-.*\\.org$".
  - Новая запись всегда формируется с ".0" (например, 2.0-...).
- Размещение:
  - Если исходником является ROOT/TODO.org — создаёт под ROOT/org/.
  - Иначе — создаёт под ROOT/<slug-имени-исходного-файла>/.
- Содержимое нового файла:
  - Заголовок (# +title:), ссылка назад на исходный документ/заголовок, блок quote с исходным поддеревом.
  - Автоматически сохраняется.
- Ссылки:
  - В исходном документе под текущим заголовком добавляется строка "Документ: [[file:REL][REL]]".
  - В TODO.org также добавляется ссылка на новый документ (если файл существует).
- Перенос поддерева:
  - Опция carriage-task-move-subtree-content (nil по умолчанию) — при t содержимое под заголовком переносится в новый файл,
    а в исходнике остаются только заголовок и ссылка. При nil — исходный текст остаётся на месте.
- Intent/Статус задачи:
  - В новом документе включается carriage-mode (если доступен) и Intent=Ask. Автоанализ выключен по умолчанию; его можно включить настройкой `carriage-task-auto-run-analysis'.
  - После создания документа статус исходной задачи переводится из TODO в следующий (по умолчанию предпочитаются THINK → DOING → NEXT; берётся первый доступный в текущем наборе TODO-ключевых слов; если нет — выполняется переход на следующий статус).
  - Если текущий заголовок не помечен как TODO (или уже в DONE-группе), выводится подтверждение (y/n) перед продолжением.
- Сохранение:
  - Новый документ и изменённый исходный документ сохраняются немедленно.

* Клавиши и меню
- Keyspec:
  - (:id task-new :cmd carriage-create-task-doc :keys ("n") :section tools :contexts (carriage org global))
  - Кнопка [n] видна в меню Carriage как при включённом carriage-mode, так и в глобальном меню (в org-файлах).
- which-key:
  - Рекомендуется добавить подпись "Create task doc" по ключу C-c e n.

* Тестирование (минимум)
- Создание из ROOT/TODO.org: файл под org/ с именем "1.0-*.org", ссылка в TODO под заголовком.
- Создание из другого org-файла: директория ROOT/<slug(origin)>/, имя "1.0-*.org", ссылка в исходнике, перенос поддерева (при t).
- Инкремент нумерации: существующие "1.0-..." и "1.1-..." → новая запись "2.0-...".
- Intent и автоанализ: Intent=Ask в новом файле; при auto=t запускается анализ.
- Сохранение: новый и исходный файлы сохранены по завершении.

* Настройки
- carriage-task-docs-dir — подкаталог для TODO.org (по умолчанию "org").
- carriage-task-filename-format — "%s-%s.org" (ordinal, slug).
- carriage-task-slugify-fn — функция слага.
- carriage-task-auto-run-analysis — автозапуск анализа (nil, выключен по умолчанию).
- carriage-task-analysis-backend/model/prompt — параметры анализа.
- carriage-task-move-subtree-content — перенос содержимого поддерева (nil).

* Ограничения
- Требуется org-mode. При отсутствии заголовка — запрашивается название.
- Для корректного глобального меню требуется keyspec и (опц.) which-key.
