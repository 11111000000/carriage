#+title: Task Docs v1 — Быстрое разворачивание файла-аналитики из TODO
#+author: Carriage Team
#+language: ru
#+options: toc:2 num:t

* Назначение
- Одна команда, которая превращает пункт TODO (заголовок в TODO.org) в отдельный файл-аналитику в каталоге org/, связывая его туда‑обратно ссылками, и (опционально) сразу запускает диалог с ИИ для сбора требований/контекста.
- Минимальное расширение поверх Carriage: без нового major‑mode, в виде отдельного небольшого модуля.

* UX и поток
1) Пользователь находится в org‑буфере, чаще всего в TODO.org на нужном заголовке.
2) Вызывает команду “Создать документ задачи” (рекомендуемая клавиша: C-c e n).
3) Инструмент:
   - Определяет корень проекта (carriage-project-root), убеждается, что в корне существует TODO.org (или предлагает указать файл).
   - Извлекает заголовок и (по возможности) текст поддерева текущего пункта TODO.
   - Находит следующий порядковый номер по файлам org/N-*.org (max(N)+1).
   - Формирует имя файла по правилу: “N-<slug>.org”, где slug — слаг из заголовка (настраиваемая функция).
   - Создаёт файл в org/, вставляет заголовок, цитату исходного TODO и ссылки туда‑обратно:
     - В новом файле: ссылка назад на TODO.org с якорем на заголовок.
     - В TODO.org: добавляется строка со ссылкой на новый документ (если ещё нет).
   - Открывает новый файл, включает org-mode и carriage-mode.
   - Опционально запускает потоковый чат (Intent=Ask) с промптом “Диалектически проанализируй задачу…”, печатая ответ прямо в документе.

* Правила именования и слаг
- Имя файла: “%d-%s.org”, где:
  - %d — автоматически определяемый следующий номер;
  - %s — слаг заголовка (нижний регистр, пробелы → “-”, удаление служебных символов; настраиваемая функция carriage-task-slugify-fn).
- Нумерация плоская (1, 2, 3, …); вложенные “2.1” сознательно не используются в MVP.

* Ссылки (взаимные)
- В новом документе (org/N-<slug>.org): строка со ссылкой назад на TODO.org через [[file:../TODO.org::*Заголовок][…]].
- В TODO.org (в исходном заголовке): добавляется строка “Документ: [[file:org/N-<slug>.org][…]]”.
- Дубликаты ссылок не создаются (повторная вставка пропускается).

* Конфигурируемость (defcustom)
- carriage-task-docs-dir (string): каталог документов (по умолчанию "org").
- carriage-task-filename-format (string): формат имени файла (по умолчанию "%d-%s.org").
- carriage-task-slugify-fn (function): функция (TITLE → SLUG).
- carriage-task-auto-run-analysis (boolean): автоматически запускать чат анализа (по умолчанию nil).
- carriage-task-analysis-backend (symbol): 'gptel|'echo (по умолчанию 'gptel).
- carriage-task-analysis-model (string|symbol): модель бэкенда (по умолчанию "gptel:default").
- carriage-task-analysis-prompt (string): текст промпта анализа.

* Команда
- carriage-create-task-doc (interactive)
  - Выполняет весь сценарий; принимает prefix-arg, чтобы временно переопределить auto-run (например, C-u — принудительно запустить/не запускать анализ).

* Интеграция с меню/клавишами
- Рекомендуемый хоткей: C-c e n (new task).
- Добавление пункта в Carriage‑меню (transient) как “Create task doc”.
- Не использовать “C-c e t” (занято под Toggles).
- Биндинг подключается через keyspec только в org-mode (контекст org); вне org не назначается.

* Анализ (чат)
- Запускаться в Intent=Ask, без требований к блокам begin_patch.
- Промпт по умолчанию:
  “Диалектически проанализируй задачу, задай вопросы с целью составить полное ТЗ, а также напиши полный список путей файлов, которые нужны для анализа этой задачи в блоке #+begin_context”
- Вставка ответа в новый документ на позиции после заголовка/контекста.
- Бэкенд/модель берутся из настроек модуля; при отсутствии gptel разрешается 'echo как фоллбэк.

* Безопасность
- Только локальные пути в пределах корня проекта; TRAMP/remote — не поддерживается.
- Создание каталогов — с подтверждением (или автоматически) в пределах root/org.

* Тестирование (минимум)
- Создание файла при наличии/отсутствии org/ каталога.
- Извлечение заголовка и текста поддерева из TODO.org.
- Нумерация и слаг (русский заголовок → латиница/ASCII; конфигурируемая функция).
- Взаимные ссылки, без дубликатов.
- Опциональный запуск анализа: корректный вызов транспорта, потоковая печать.
- Повторный вызов на том же заголовке — либо создание нового документа (новый номер), либо опция “переоткрыть существующий” (в будущем).

* Расширение сценариев (следующие версии)
- Реестр сценариев анализа (несколько шагов/моделей), выбор сценария перед запуском.
- Автоматическая вставка пустого #+begin_context/# +end_context для списка файлов (можно включить уже в MVP).

* План реализации (в общих чертах)
1) Реализовать модуль lisp/carriage-task.el с командой carriage-create-task-doc и набором defcustom.
2) Простая слаг‑функция (с возможностью заменить на “умную” транслитерацию).
3) Поиск следующего номера по маске “N-*.org”.
4) Шаблон содержимого нового файла (заголовок, ссылка назад, цитата контекста).
5) Обновление TODO.org: добавление ссылки на документ.
6) Опциональный запуск анализа (carriage-transport-dispatch), с префикс‑аргументом для быстрого переключения.
7) Документация (эта спецификация) и пункт в меню (в отдельном шаге).

* Вопросы открытой архитектуры (не блокируют MVP)
- Регистрация сценариев анализа (алист id→fn).
- Встраивание в keyspec (через overlays) для профилей клавиш.
- Обработка не‑org исходников (если команда вызвана не из TODO.org) — сейчас просто спрашивать заголовок.

* Пример шаблона содержимого нового документа
#+begin_src org
#+title: <Заголовок задачи>

См. TODO: [[file:../TODO.org::*<Заголовок задачи>][перейти]]

* <Заголовок задачи>

** Исходный контекст
#+begin_quote
<Вставленное содержимое из TODO (поддерево или отмеченный текст)>
#+end_quote

** Анализ
; Здесь начнётся потоковый ответ ИИ (если включено auto-run)
#+end_src


* Следующий шаг
- Создать модуль lisp/carriage-task.el (команда, настройки, UX).
- По желанию: добавить пункт в Carriage‑меню (через keyspec overlay или transient-генератор).
- Юнит‑тесты на нумерацию/слаг/ссылки.

#+begin_context
spec/task-docs-v1.org            ; (create) — текущая спецификация
lisp/carriage-task.el            ; (create) — реализация команды и настроек (MVP)

; возможные дальнейшие правки (после MVP):
lisp/carriage-keyspec.el         ; (patch) — добавить пункт меню "Create task doc" (без жёсткой привязки ключа)
spec/keyspec-v1.org              ; (patch) — дополнить рекомендации по хоткею C-c e n
spec/project-overview-v1.org     ; (patch) — указать новый модуль в карте исходников
spec/testing-v1.org              ; (patch) — добавить тесты по task-docs
#+end_context
