#+title: Project Structure v1 — Слои, каталоги, зависимости
#+author: Carriage Team
#+language: ru
#+options: toc:2 num:t

* Назначение
- Зафиксировать структуру репозитория и границы слоёв, чтобы новые части проекта появлялись в правильных местах и с понятными контрактами.

* Директории
- lisp/ — исходники (ядро и модули):
  - carriage-*.el — ядро и домен: errors, logging, utils, git, parser, apply, iteration, ui, report, mode, entry.
  - engines/ — движки применения (реестр и реализации: git, emacs, magit и др.).
  - transports/ — адаптеры LLM/агентов (например, gptel, JSON-RPC), опционально.
  - ops/ — оп-модули (:op): один файл на формат; рядом публикуются фрагменты промптов. Suite собирает системный промпт из этих фрагментов.
  - carriage-intent-registry.el — реестр интентов (фрагменты промптов Intent; CTX → STRING).
  - carriage-suite.el — компоновщик Suite/Prompt Builder: собирает системный промпт из фрагментов ops и intent; публичная функция carriage-build-prompt (pure).
  - (удалено в v1.1) — DELIM для :op \"create\" больше не используется; санитайзер и парсер принимают «сырой» контент тела блока.
  - ui/ — доп. компоненты UI/виджеты (опционально).
- spec/ — спецификации (норматив и разъяснения).
  - prompt-profiles-v1.org — Intent/Suite и композиция промптов (один язык; i18n не применяется к промптам; замены/расширения через overrides/overlays).
  - extensibility-points-v1.org — точки расширения (ops, транспорты, UI) и правила сборки Suite.
  - testing-v1.org — план тестов (юниты/интеграция), включая проверки промпт-билдера.
- test/ — ERT и интеграционные фикстуры (git-репо).
- scripts/ — batch-скрипты (lint, compile-strict, checkdoc).
- examples/ — «golden» документы.
- .context/ — персистентное состояние проекта (например, ".context/carriage/carriage-state.el").

* Слои и зависимости (направление сверху вниз запрещено)
- Core: errors → logging → utils → git
- Domain: parser → apply → report
- Mode/UI: ui → iteration → mode → entry (carriage.el)
- Transports: transports/* (зависит только от errors/logging/utils; не зависит от UI)
- Правила:
  - UI не импортируется из parser/apply.
  - Транспорт не модифицирует глобальные переменные Emacs.

* Именование и provide
- Имя файла и feature: carriage-foo.el → (provide 'carriage-foo).
- Публичные API: carriage-foo-bar; внутренние: carriage--foo-bar.
- defcustom — в одном «владельце» слоя; остальные файлы — declare-variable при необходимости.
- Интерактивные команды — ;;;###autoload.

* Порядок загрузки
- carriage.el: require errors→(carriage-define-errors)→logging→utils→git→carriage-format-registry→carriage-intent-registry→carriage-suite→parser→apply→ops→mode.
- Транспорты подключаются через абстракцию (см. llm-transport-v1), не require-ятся по умолчанию.

* Тестирование/CI
- Юнит: ERT на парсеры/апплаеры/утилиты.
- Интеграция: тестовый git-репозиторий.
- Моки транспорта (gptel-mock).
- CI: byte-compile (строго), checkdoc, package-lint, ert.

* Миграция v1→v1.1 (без ломки)
- Устранить дубли defcustom/defvar.
- Синхронизировать предупреждения SRE_W_*.
- Вынести транспорты в lisp/transports/.

* Дополнения v1.1
- Новые спецификации в каталоге spec/:
  - context-integration-v1.org — единая модель включения контекста (gptel + блоки документа).
  - keyspec-v1.org — спецификация централизованной модели биндингов и генераторов which-key/transient/hydra.
  - i18n-v1.org — слой локализации (переводы ru/en, ключи для UI/which-key/transient).

* Дополнения v1.2 — Ключи и глобальный режим
- Новые модули (lisp/):
  - carriage-keys.el — применение keyspec к картам, генерация which-key/transient, линтер коллизий.
  - carriage-global-mode.el — глобальный минор-режим для префикса C-c e (контекст global).
- Перенос ответственности:
  - В carriage-ui.el не должно быть defvar/define-key для основной карты режима; все биндинги — через keyspec и модули выше.
- Проектный буфер:
  - Реализация команды carriage-open-buffer (управление уникальностью на проект, маркировка «эфемерности», хук выхода).
