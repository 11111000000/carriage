#+title: Security v1 — Политики безопасности
#+author: Peter Kosov <11111000000@email.com>
#+language: ru
#+options: toc:2 num:t

* Цели
- Предотвратить опасные изменения файловой системы и репозитория.
- Снизить риски из-за ошибок модели и некорректных патчей.

* Политика путей
- Только относительные пути внутри корня репозитория.
- Запрет абсолютных путей и переходов «..».
- Нормализация и проверка symlink-цепочек (deny-by-default при выходе за рабочее дерево).

* Ограничения форматов v1
- Бинарные патчи запрещены (patch).
- Только один файл на блок (patch), /dev/null для create/delete.
- Для SRE: :occur all → обязательное :expect; любые значения, кроме 'first|'all → SRE_E_OCCUR_VALUE.
- Для AIBO: регулярные выражения запрещены; ключ :match не допускается.
- TRAMP/remote: в v1 применение отключено (запрещено); необходимо проверять (file-remote-p) и отказывать.

* Git-операции
- Ветки: политика выбирается настройкой (см. ./apply-engines-v1.org): 'in-place | 'wip (carriage/WIP) | 'ephemeral. Dry-run не создаёт и не переключает ветки.
- Запрет использования --unsafe-paths.
- Dry-run обязателен: для patch — git apply --check; для SRE/AIBO — симуляция замен без записи.

* EOL и кодировки
- Инструмент сохраняет исходный стиль EOL; принудительная нормализация в v1 не поддерживается. Исключение: при :op "create", если :ensure-final-newline=t — добавляется завершающая новая строка.
- Unicode-нормализация не выполняется.
- При смешанных EOL допускается предупреждение в отчёте dry-run.

* Ресурсные лимиты
- Нормативные значения лимитов: см. ./index.org (секция FREEZE).

* Трассировка и логи
- Логи действий с временем, путями и статусом; без отправки наружу.
- Опциональное сохранение сырого ответа LLM для воспроизводимости.

* Угрозы и смягчения
- Галлюцинации модели → строгая схема формата, валидаторы, отказ по умолчанию.
- Путь вне репозитория → отказ.
- Конфликты при применении → dry-run, предпросмотр, подтверждение, отказ при ошибке.
- Привилегии пользователя → операторы git выполняются в текущем окружении, без повышения привилегий.

* Дополнительно для источника 'visible
- Исключать буфер-инициатор (current-buffer), из которого запущена сборка контекста (по умолчанию).
- EXWM окна/буферы (major-mode exwm-mode) не включаются в контекст.
- TRAMP/remote буферы не включаются (file-remote-p t).
- Терминальные/коминтовые/сообщения буферы включаются хвостом N строк (по умолчанию 256).
- Дедупликация с doc/gptel: по нормализованному пути (файлы) или имени буфера (нефайловые); при конфликте оставлять один элемент, остальные помечать omitted с причиной 'duplicate.
