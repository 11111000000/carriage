#+title: Git Integration v1
#+author: Peter Kosov <11111000000@email.com>
#+language: ru
#+options: toc:2 num:t

* Обнаружение репозитория
- project.el → project-root
- Если не найдено — git rev-parse --show-toplevel
- При отсутствии репозитория — режим применение блоков запрещён.

* Ветка WIP
- Имя: carriage/WIP
- Стратегия:
  - Создать при первом применении, переключиться.
  - Защита от push (по настройке).
  - Возможность сброса (soft reset) последнего коммита через команду UI.

* Команды git (референс)
- Проверка: git apply --check --directory=<root> [--reject] [--verbose]
- Применение: git apply --index --directory=<root> [--reject]
- Индексация: git add <path>
- Коммит: git commit -m "carriage: {op} {file}"
- Переименование: git mv (для :op rename из других спецификаций)

* Незакоммиченные изменения
- Политика (настройка):
  - warn — предупреждать и продолжать (по умолчанию)
  - stash — временно сохранять и восстанавливать
  - abort — запрещать применение

* Пути и безопасность
- Запрет абсолютных путей и «..».
- Политика symlink: deny-by-default (отказ при попытке выйти за рабочее дерево); после нормализации проверять (file-truename) на префикс корня репозитория.
- TRAMP/remote: не поддерживается; проверять (file-remote-p) и отказывать.
- Подмодули: в v1 не поддерживается применение патчей внутрь подмодулей.

* Сообщения коммитов
- Шаблон: "carriage: {op} {file|path}".
- Дополнение: количество замен для SRE, число хунков для patch (опционально).
