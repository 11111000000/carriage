#+title: Git Integration v1
#+author: Peter Kosov <11111000000@email.com>
#+language: ru
#+options: toc:2 num:t

* Обнаружение репозитория
- project.el → project-root
- Если не найдено — git rev-parse --show-toplevel
- При отсутствии репозитория — режим применение блоков запрещён.

* Политики веток
- Политика выбирается настройкой carriage-git-branch-policy: 'in-place | 'wip | 'ephemeral (по умолчанию 'in-place).
- in-place: применять в текущей ветке; dry-run не создаёт/не переключает ветки.
- wip: ensure и checkout ветки carriage/WIP перед применением; dry-run не создаёт/не переключает ветки; защита от push (по настройке); доступен soft reset последнего коммита.
- ephemeral: создать временную ветку carriage/tmp/<YYYYmmdd-HHMMSS>-<shortid>, применить изменения, затем вернуться на исходную ветку; пустые ветки после отсутствия изменений — автоудаляются; при ошибках ветка сохраняется.
- Переключение назад на исходную ветку по окончании пайплайна: carriage-git-switch-back-on-complete (t по умолчанию).

* Команды git (референс)
- Эти команды описывают реализацию движка 'git по умолчанию:
  - Проверка: git apply --check --directory=<root> [--reject] [--verbose]
  - Применение: git apply [--index] --directory=<root> [--reject] (флаг --index включается при carriage-apply-stage-policy='index)
  - Индексация: git add <path> (только при policy='index или в отдельных командах стадирования)
  - Коммит: git commit -m "…" — выполняется отдельными командами пользователя (не частью apply)
  - Переименование: git mv (для :op rename из других спецификаций)
  - Ветки: ensure/checkout/создание веток выполняются только на стадии apply и только после успешного dry-run; dry-run ветки не создаёт и не переключает.
- Наблюдаемость: каждый вызов движка фиксируется (begin/exec/pid/exit/timeout) в *carriage-log*; автокоммита в apply нет.
- Другие движки могут реализовывать эквивалентную семантику (см. ./apply-engines-v1.org).

* Незакоммиченные изменения
- Политика (настройка):
  - warn — предупреждать и продолжать (по умолчанию)
  - stash — временно сохранять и восстанавливать
  - abort — запрещать применение

* Пути и безопасность
- Политика путей и symlink: см. ./security-v1.org.
- TRAMP/remote: см. ./security-v1.org (в v1 отключено).
- Подмодули: в v1 не поддерживается применение патчей внутрь подмодулей.

* Сообщения коммитов
- Шаблон: "carriage: {op} {file|path}".
- Дополнение: количество замен для SRE, число хунков для patch (опционально).
