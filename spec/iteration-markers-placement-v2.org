#+title: Iteration Markers Placement v2 — Location rules and ergonomics
#+author: Peter Kosov <11111000000@email.com>
#+language: en
#+options: toc:2 num:t
#+property: header-args :results silent

Meta
- Spec-ID: carriage/docs/iteration-placement/v2
- Version: v2.0
- Status: draft
- Normativity: RFC 2119 applies
- Ownership: docs
- Prompt-ABI: v1
- Pack-Profiles: P3-debug
- Precedence: Security > Errors > Formats > Interfaces > Algorithms > UI
- RAG-Indexing: on
- Fingerprint: <auto>

Purpose
- Anchor: PURPOSE
- Normative: t
- Stability: stable
- Pack-Priority: P3
- LLM-Summary: Define where to place iteration markers for best UX and reliability.

Scope
- Anchor: SCOPE
- Normative: t
- Stability: stable
- Pack-Priority: P3
- Applies to Carriage documents where iterations are collected by the UI/collector.

Terms
- Anchor: TERMS
- Normative: t
- Stability: stable
- Pack-Priority: P3
- Marker: inline token delimiting an iteration; see iteration-v2.

Normative Requirements
- Anchor: REQ
- Normative: t
- Stability: stable
- Pack-Priority: P3
- REQ-ip-001: Place marker before first block of iteration; avoid nesting across markers.
- REQ-ip-002: One active marker per iteration; last one wins if multiple exist.
- REQ-ip-003: Do not place markers inside code blocks to avoid accidental edits.

Invariants
- Anchor: INV
- Normative: t
- Stability: stable
- Pack-Priority: P3
- INV-ip-001: Markers are unique per iteration context.

Grammar/Schema
- Anchor: SCHEMA
- Normative: t
- Stability: stable
- Pack-Priority: P3
- Marker form: inline text property or explicit sentinel line understood by collector.

Interfaces/Contracts
- Anchor: IFC
- Normative: t
- Stability: stable
- Pack-Priority: P3
- IFC-ip-001: iteration-locate BUFFER → POS of last valid marker (fallback to last).

Algorithms
- Anchor: ALG
- Normative: t
- Stability: stable
- Pack-Priority: P3
- ALG-ip-001: Collector scans bottom-up, preferring the last valid marker.

Errors and Diagnostics
- Anchor: ERR
- Normative: t
- Stability: stable
- Pack-Priority: P3
- IP_E_MULTIPLE — conflicting markers; last one chosen with warning.

Security and Limits
- Anchor: SEC
- Normative: t
- Stability: stable
- Pack-Priority: P3
- Not applicable.

Performance and Asynchrony
- Anchor: PERF
- Normative: t
- Stability: stable
- Pack-Priority: P3
- O(buffer-size) scan with early stop when last marker found.

UI/UX
- Anchor: UI
- Normative: t
- Stability: stable
- Pack-Priority: P3
- UI SHOULD show marker location and provide jump-to actions.

Prompt Guidance
- Anchor: PRM
- Normative: t
- Stability: stable
- Pack-Priority: P3
- Not applicable.

Context Packaging
- Anchor: PACK
- Normative: t
- Stability: stable
- Pack-Priority: P3
- Not included in prompts.

Retrieval and Indexing
- Anchor: RAG
- Normative: t
- Stability: stable
- Pack-Priority: P3
- Index REQ and INV for assistant hints only.

Precedence Rules
- Anchor: PREC
- Normative: t
- Stability: stable
- Pack-Priority: P3
- Source of Truth: iteration-v2 for marker semantics.

Testing and Conformance
- Anchor: TST
- Normative: t
- Stability: stable
- Pack-Priority: P3
- TST-ip-001: placement rules observed by collector and UI.

Cross-References and Anchors
- Anchor: XREF
- Normative: t
- Stability: stable
- Pack-Priority: P3
- Code:
  - lisp/carriage-iteration.el
  - lisp/carriage-ui.el

Evolution
- Anchor: EVO
- Normative: t
- Stability: stable
- Pack-Priority: P3
- Affects-Prompt: none

