#+title: API v1 — Публичные команды, переменные, лица
#+author: Peter Kosov <11111000000@email.com>
#+language: ru
#+options: toc:2 num:t
#+property: header-args :results silent

* Назначение
- Нормативный публичный API Carriage-mode v1: интерактивные команды, переменные, лица (faces).

* Интерактивные команды (stable)
- carriage-mode
  - Минор-режим; включает функциональность только в org-mode буферах.
- carriage-send-buffer (C-c M-RET)
  - Отправить весь документ в LLM с активным Intent (Ask|Patch).
- carriage-send-subtree (C-c RET)
  - Отправить текущее поддерево org.
- carriage-apply-at-point (C-c C-c)
  - Dry-run → подтверждение → применить блок =patch= под точкой.
- carriage-apply-last-iteration (C-c !)
  - Применить все блоки последнего ответа.
- carriage-dry-run-at-point (C-c ?)
  - Только dry-run блока под точкой (или всей итерации с C-u).
- carriage-wip-checkout (C-c b c)
  - Создать/перейти на ветку carriage/WIP.
- carriage-show-log (C-c b l)
  - Показать лог применений.
- carriage-show-traffic (C-c b t)
  - Показать трафик LLM (вход/выход).
- carriage-show-log-and-traffic (C-c b L)
  - Открыть лог и трафик одновременно в правых боковых окнах.
- carriage-wip-reset-soft (C-c b r)
  - Откат последнего коммита (soft reset).
- carriage-toggle-intent
  - Переключить Intent (Ask|Patch).
- carriage-select-suite
  - Выбрать Suite (auto|sre|patch|fileops).
- carriage-select-backend
  - Выбрать бэкенд (транспорт) LLM.
- carriage-select-model
  - Выбрать модель для текущего бэкенда.

* Программный интерфейс (Elisp)
- Парсинг/применение:
  - carriage-parse-blocks-in-region (beg end) → PLAN
  - carriage-collect-last-iteration-blocks () → PLAN
  - carriage-dry-run-plan (PLAN) → REPORT
  - carriage-apply-plan (PLAN) → RESULT
- Служебные:
  - carriage-project-root () → DIR
  - carriage-generate-delim () → STRING
  - carriage-report-buffer () → BUFFER
  - carriage-log-buffer () → BUFFER
  - carriage-traffic-buffer () → BUFFER
  - carriage-clear-logs () → t
- Потоковая печать:
  - carriage-insert-stream-chunk (STRING &optional TYPE) → POS   ; TYPE ∈ ('text 'reasoning), вставляет в активный «ответный» регион
  - carriage-begin-reasoning () → POS                              ; открыть #+begin_reasoning при первом reasoning-чане
  - carriage-end-reasoning () → POS                                ; закрыть #+end_reasoning при (reasoning . t)/завершении
  - carriage-stream-region () → (BEG . END)                        ; текущие границы региона ответа в буфере
  - carriage-stream-reset () → t                                   ; сброс состояния печати (при новом запросе/ошибке/abort)

* Переменные Customize
- carriage-mode-default-intent (symbol) — 'Ask | 'Patch
- carriage-mode-default-suite (symbol) — 'auto-v1 | 'sre-v1 | 'patch-v1 | 'file-ops-v1
- carriage-mode-default-backend (symbol|string) — имя бэкенда транспорта по умолчанию (например, 'gptel)
- carriage-mode-default-model (string) — имя модели для выбранного бэкенда
- carriage-mode-state-file (string) — путь к файлу состояния в проекте (".context/carriage/carriage-state.el")
- carriage-mode-wip-branch (string) — "carriage/WIP"
- carriage-mode-confirm-apply-all (boolean) — t
- carriage-mode-auto-open-report (boolean) — t
- carriage-mode-auto-open-log (boolean) — nil
- carriage-mode-auto-open-traffic (boolean) — nil
- carriage-mode-show-diffs (boolean) — t
- carriage-mode-show-header-line (boolean) — t
- carriage-mode-show-mode-line-ui (boolean) — t
- carriage-mode-spinner-interval (number) — 0.15
- carriage-mode-headerline-max-width (integer or nil) — nil
- carriage-mode-use-icons (boolean) — t
- carriage-mode-include-reasoning (symbol) — 'block | 'ignore — политика вставки reasoning в исходный буфер (по умолчанию 'block: #+begin_reasoning/#+end_reasoning)
- carriage-mode-allow-patch-binary (boolean) — nil (v1)
- carriage-mode-max-batch-pairs (integer) — лимит пар в SRE-BATCH
- carriage-mode-sre-noop-on-zero-matches (boolean) — noop при 0 совпадений для :occur first
- carriage-mode-log-max-lines (integer) — предел строк для *carriage-log*/*carriage-report*.
- carriage-mode-traffic-max-lines (integer) — предел строк для *carriage-traffic*.
- carriage-mode-aux-window-side (symbol) — сторона бокового окна для логов/трафика: left|right|top|bottom.
- carriage-mode-aux-window-size (number) — относительный размер бокового окна (0–1).
- carriage-mode-aux-window-reuse (boolean) — переиспользовать уже открытое окно для буферов логов/трафика.

* Лица (faces)
- carriage-patch-valid-face
- carriage-patch-warning-face
- carriage-patch-error-face
- carriage-report-ok-face
- carriage-report-warn-face
- carriage-report-err-face

* Стабильность API
- Символы и сигнатуры в этом файле считаются стабильными для v1.
- Изменения возможны только добавлением новых опций/команд без ломки существующих.
