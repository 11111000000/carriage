#+title: Carriage — Спецификация оптимизаций производительности (v1.3)
#+author: Carriage Team
#+language: ru

В этой спецификации зафиксированы изменения и рекомендации, направленные на снижение нагрузки на redisplay и ускорение UI‑операций Carriage в Emacs. Изменения совместимы с v1 и не затрагивают формат патчей.

* Ключевые изменения

1) Снижен объём и частота перерисовок (redisplay)
- Спиннер модлайна обновляется только для видимых окон соответствующего буфера и без глобального обновления всех окон.
- Пре‑лоадер (индикатор до начала стриминга) тикает только когда буфер реально отображается в каком‑либо окне.

2) «Заморозка» UI во время transient (меню)
- На время работы transient (recursive‑edit) спиннер/пре‑лоадер останавливаются; после выхода состояние восстанавливается. Это резко уменьшает долю redisplay во время выбора действий в меню.

3) Контекстный бейдж в модлайне (Context)
- Кэш бейджа больше не зависит от точки (point) — пересчёт определяется TTL, модификацией буфера (buffer‑chars‑modified‑tick) и состоянием соответствующих тогглов. Это исключает лишние перерасчёты при перемещении курсора.

4) Кэш имени ветки (Branch) для модлайна
- Имя текущей ветки теперь берётся из лёгкого буферного кэша с ограничением по времени; избегаются дорогие запросы через VC/Git на каждом рендере модлайна.

5) Отчёт: отказ от дорогостоящего org-table-align
- Рендер отчёта больше не зависит от выравнивания таблицы средствами Org. Используется легковесное построчное рендеринг/раскраска, кнопки действий ([Diff]/[Ediff]/[Apply]) сохраняются.

* Конфигурация и параметры

- carriage-mode-spinner-interval (число, сек; по умолчанию 0.15)
  Интервал обновления спиннера. Для грузных конфигураций рекомендуется 0.2–0.25.

- carriage-mode-preloader-interval (число, сек; по умолчанию 0.2)
  Интервал обновления пре‑лоадера; для минимизации перерисовок допустимо 0.3–0.4.

- carriage-ui-context-cache-ttl (число в секундах; 0 — пересчитывать всегда; nil — бесконечно до изменения буфера)
  TTL кэша контекстного бейджа. Рекомендуем 2–3 секунды на больших проектах.

- carriage-ui-branch-cache-ttl (число или nil)
  TTL кэша имени ветки для модлайна. При nil значение сохраняется до явной смены/сброса; при числе обновляется по таймеру.

- carriage-traffic-batch-interval / carriage-traffic-batch-bytes-threshold
  Настройки батчинга логов трафика. Для снижения churn UI целесообразно увеличить интервал до 0.08–0.12 и порог до ~16KiB.

* Поведенческие изменения (детали реализации)

- Спиннер
  - Отказ от глобального (force-mode-line-update t) в пользу локального обновления модлайна.
  - Тик только при видимости окна буфера.

- Пре‑лоадер
  - Проверка видимости окна буфера перед перерисовкой оверлея.
  - Автоматическая остановка при переходе к фазе стриминга или при завершении.

- Transient (меню)
  - На время recursive‑edit UI «замораживается» (спиннер/пре‑лоадер останавливаются), после выхода состояние восстанавливается.

- Контекстный бейдж
  - Ключ кэша: (инклюд‑тогглы, buffer‑chars‑modified‑tick, TTL). Точка курсора из ключа исключена.

- Ветка (Branch)
  - Имя ветки определяется редко (кэшируется); модлайн читает только кэш.
  - Сброс кэша инициируется через таймаут/явные действия Git.

- Отчёт
  - Рендер строк без org-table-align, кнопки кликабельны как и прежде.
  - Добавлены ограждения от лишних перерисовок: inhibit-read-only/inhibit-modification-hooks/минимизация проходов.

* Рекомендации по эксплуатации

- На больших Org‑файлах можно временно отключить шапку (header-line):
  (setq carriage-mode-show-header-line nil)

- Для минимизации визуальной нагрузки:
  - (setq carriage-mode-use-icons nil)
  - Исключить тяжёлые блоки из модлайна, например ‘branch’ и ‘context’:
    (customize-set-variable 'carriage-ui-modeline-blocks
      '(suite engine model intent state patch dry apply all abort report))

- Плагины оформления (например, org-modern) заметно увеличивают стоимость redisplay. На время «тяжёлых» действий (меню/массовые операции) их влияние сглаживается благодаря «заморозке» Carriage‑UI, но при систематических нагрузках можно временно отключать дополнительные украшения.

* Совместимость

- Форматы патчей (SRE/AIBO/patch, file‑ops) не изменены.
- Изменения затрагивают только UI/рендеринг/кэширование; внешний API и команды остаются прежними.
- При необходимости откатить оптимизации — верните прежние значения интервалов, отключите кэш по TTL или выключите настройки через Customize.

* Диагностика

- Используйте M-x profiler-start (cpu) и повторяйте сценарии: запуск меню, apply last iteration, рендер отчёта. Доля redisplay_internal должна снизиться.
- elp/benchmark-run для:
  - carriage-ui--modeline
  - carriage-ui--context-badge
  - carriage-report-render

* Изменённые участки кода (референс)

- lisp/carriage-ui.el
  - Спиннер/пре‑лоадер: проверка видимости окна; локальные обновления модлайна.
  - Контекстный бейдж: кэш без зависимости от point.
  - Кэш имени ветки для модлайна.

- lisp/carriage-mode.el
  - «Заморозка» UI на время работы transient (recursive‑edit).

- lisp/carriage-report.el
  - Лёгкий построчный рендер таблицы вместо org-table-align.

Данные изменения ориентированы на снижение 70–80% времени, теряемого на redisplay_internal в типичном профиле с активным transient и/или частыми обновлениями модлайна.
