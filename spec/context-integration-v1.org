#+title: Context Integration v1.1 — Единая модель контекста (gptel + документ)
#+author: Carriage Team
#+language: ru
#+options: toc:2 num:t

* Цели
- Единая модель включения контента при формировании запроса:
  - Источники gptel-context (буферы/файлы/оверлеи).
  - Явный контекст-документа через блоки #+begin_context … #+end_context.
- Управление включением через тумблеры в модлайне и команды.
- Лимиты и безопасность, независимые от бэкенда транспорта.

* Переключатели (буферно-локальные)
- carriage-mode-include-gptel-context (t по умолчанию)
  - Включать файлы/буферы из gptel-context; для файлов — указывать путь (относительно корня проекта) и содержимое (с учётом лимитов).
- carriage-mode-include-doc-context (t по умолчанию)
  - Включать файлы, указанные в блоке #+begin_context … #+end_context в текущем буфере (или родительских заголовках в org).
- Команды:
  - carriage-toggle-include-gptel-context (C-c e t c)
  - carriage-toggle-include-doc-context (C-c e t f)

* Блок контекста в документе
- Формат:
  #+begin_context
  ./relative/path1
  ../relative/path2
  /abs/path (запрещено, если вне корня проекта)
  #+end_context
- Поиск:
  - В org-mode: ближайший блок в текущем заголовке; при отсутствии — поднимаемся к родительским заголовкам.
  - В не-org буфере: первый блок в буфере.
- Нормализация путей:
  - Относительные пути — относительно project-root (git) или default-directory.
  - Абсолютные пути допустимы только если остаются внутри project-root.
  - TRAMP пути запрещены (отказ).

* Включение в запрос
- Инъекция контекста:
  - carriage-mode-context-injection: 'system (по умолчанию) | 'user.
- Политика включения:
  - Для каждого файла (из gptel-context и/или блока документа):
    - Добавить путь (относительный к корню проекта) и содержимое в секции контекста.
    - Бинарные файлы: содержимое не включается; можно добавить только путь и предупреждение.
  - Для буферных оверлеев: включать выжимки с заголовком "In buffer <name>, lines a..b:".
  - Дедупликация по truename.
- Лимиты (FREEZE v1.1):
  - carriage-mode-context-max-files: максимум 100 файлов.
  - carriage-mode-context-max-total-bytes: максимум 1024 KiB суммарного текста.
  - При превышении лимитов: включить только пути + краткое summary; добавить верхнее предупреждение.

* Безопасность
- Запрет на TRAMP/remote.
- Жёсткая нормализация путей; запрет выхода за корень проекта.
- Отказ для небезопасных путей (OPS_E_PATH) с диагностикой.

* Диагностика
- В лог/отчёт добавлять:
  - список включённых файлов/буферов,
  - число пропущенных элементов и причину (лимиты, запреты),
  - предупреждения о суммарном объёме.

* Тестирование (см. testing-v1.org)
- Парсинг блока, нормализация, отказ TRAMP.
- Дедупликация путей из разных источников.
- Лимиты 100 файлов / 1024 KiB.
- Инъекция в system/user по настройке.
