#+title: Emacs Engine (udiff) Implementation Plan v1
#+language: en
#+options: toc:2 num:t

* Goal
Provide a pure-Emacs apply engine capable of applying single-file unified diffs
(udiff) without external tools, as a universal fallback.

* Scope (v1)
- Text-only, single-file diffs.
- Support create (from /dev/null) and modify hunks; delete is allowed when target becomes empty (optional).
- No rename/copy detection.
- No binary patches.
- Strip policy: support :strip=1 (a/.., b/..) and validate.
- CRLF/encoding: best-effort; operate on Emacs buffers using utf-8-unix.

* Algorithm
1) Parse headers: --- a/… +++ b/…
   - Validate path equality (after strip).
   - Map to repository-relative target path.
2) Load file content (or empty for create).
3) Parse hunks:
   - @@ -lN,sN +lM,sM @@
   - Collect old/new text fragments.
4) Verify applicability (check only pass):
   - Reconstruct expected old regions (with context) and match against current buffer.
   - Fail early on mismatch.
5) Apply:
   - Transform buffer text hunk-by-hunk in reverse order (bottom-up) to avoid offset drift.
6) Report:
   - :status, :engine 'emacs, :changed-bytes, and diagnostics on failures.

* Edge cases
- Context mismatches -> fail with PATCH_E_GIT_CHECK equivalent code for parity.
- EOL normalization: do not rewrite unrelated lines.
- Large files: use narrowing and save-excursion.

* Integration
- Register engine 'emacs with :ops including 'patch 'create 'delete 'rename 'sre 'aibo as no-ops/pass-through except 'patch where it applies udiff.
- Engine selection UI keeps 'emacs visible; for v1, 'patch via 'emacs is disabled unless this engine is fully implemented.

* Testing
- Golden udiff fixtures (test/golden/udiff-basic.org).
- ERT:
  - dry-run passes on simple udiff (modify/create) without Git.
  - apply updates buffer and file on disk.
  - invalid strip/header/path: signal appropriate errors.
  - NOOP diff results in 'skip or 'ok with Δbytes=0.

* Future
- Multi-file diffs, rename/copy support, binary policies, fuzzy hunks.
