#+title: I18N v1 — Слой локализации и переводы
#+author: Carriage Team
#+language: ru
#+options: toc:2 num:t
#+property: header-args :results silent

* Назначение
- Единый слой локализации (i18n) для всех пользовательских строк в UI:
  - заголовки групп transient-меню,
  - подписи кнопок и help-echo в mode-line/header-line,
  - which-key подсказки,
  - сообщения в отчётах и диагностике (минимально в v1).

* Цели
- Централизованный словарь переводов «ключ → строки» для ru/en.
- Отсутствие глобальных побочных эффектов (смена локали не ломает чужие буферы).
- Возможность буферно-локальной локали при необходимости.

* Модель данных
- Таблица (alist): (:key . ((ru . "…") (en . "…")))
- Языки: ru (по умолчанию), en (fallback).
- Ключи — символы (например, :menu-title, :tools, :act, :session, :logs, :model-select, :toggle-ctx, :toggle-doc, :engine, …).

* API (Elisp, норматив)
- carriage-i18n (KEY &rest ARGS) → STRING
  - Возвращает строку согласно текущей локали; ARGS подставляются через format.
  - Поведение при отсутствии ключа/перевода: fallback на en; при отсутствии и там — (symbol-name KEY).
- carriage-i18n-set-locale (LOCALE) → t
  - Устанавливает глобальную локаль ('ru|'en). Должна инициировать обновление UI (force-mode-line-update) в активных буферах Carriage.
- carriage-i18n-locale (defcustom)
  - Текущая локаль ('ru по умолчанию).
- carriage-i18n-known-keys () → LIST
  - Список известных ключей (для тестов покрытия).
- carriage-i18n-format (KEY &rest ARGS) → STRING
  - Синоним carriage-i18n, оставлен для выразительности.

* Интеграция
- UI (ui-v1.org):
  - Все видимые подписанные элементы (кнопки, help-echo, заголовки) разрешаются через i18n-ключи.
  - Tooltip [MODEL] — шаблон из i18n, например: (:model-tooltip . "Модель: %s").
  - Tooltip [ENGINE] — шаблон из i18n; для 'git использовать форму "Движок: %s (ветки: %s)" с ключом :engine-tooltip-branch и подстановкой политики ('in-place|'wip|'ephemeral); общий случай — :engine-tooltip.
- which-key:
  - Реплейсеры строятся через i18n-ключи: (:carriage-menu . "Carriage Menu"), (:carriage-toggles . "Carriage Toggles").
- keyspec/transient:
  - Заголовки групп секций — i18n-ключи: (:tools-title, :act-title, :session-title, :logs-title, :navigate-title).
  - Подписи действий — по :desc-key в keyspec; если :desc-key отсутствует — fallback к (symbol-name cmd).
- Fallback:
  - В TTY/fallback-меню (без transient) также использовать i18n-префиксы: "[Tools] …", "[Actions] …".

* Тестирование
- Переключение локали меняет заголовки групп transient и which-key (при наличии).
- Политика fallback: при отсутствии key/locale → en → (symbol-name KEY).
- Покрытие основных ключей: menu title, секции, кнопки, help-echo, подсказки which-key.

* Проектная структура
- lisp/carriage-i18n.el — реализация слоя i18n (defgroup/defcustom, функции API и алфавит переводов).
- Подключение из UI и keyspec: require 'carriage-i18n (лениво/опционально, безопасно при отсутствии — fallback к сырой строке).

* Эволюция
- v1.1: базовый слой и покрытие UI; расширение на сообщения отчётов/ошибок возможно без ломки API.

* Ключи (минимум v1.2)
- Рекомендуемые ключи для перевода which-key/transient/меню:
  - :send-buffer — подпись действия «Отправить буфер».
  - :send-subtree — подпись действия «Отправить поддерево».
  - :open-buffer — «Открыть буфер Carriage».
  - :carriage-menu — заголовок/подсказка «Carriage Menu».
  - :carriage-toggles — заголовок/подсказка «Carriage Toggles».

* Ключи (дополнение v1.3)
- UI/Mode-line:
  - :suite — метка "Suite".
  - :engine — метка "Engine".
  - :suite-tooltip — всплывающая подсказка для выбора Suite.
  - :engine-tooltip — всплывающая подсказка для выбора Engine.
  - :engine-tooltip-branch — шаблон тултипа для git (например, "Движок: %s (ветки: %s)").
  - :commit — метка кнопки Commit.
  - :commit-tooltip — подсказка для Commit.
  - :intent-ask — метка Intent Ask.
  - :intent-code — метка Intent Code.
  - :intent-hybrid — метка Intent Hybrid.
  - :ctx-toggle — метка тумблера контекста (gptel-context).
  - :files-toggle — метка тумблера файлов (#begin_context).
  - :ctx-tooltip — подсказка для тумблера контекста.
  - :files-tooltip — подсказка для тумблера файлов.
  - :model-tooltip — шаблон тултипа модели (например, "Модель: %s").
- Эффекты и уведомления:
  - :flash-enabled — описание опции мигать патчами.
  - :audio-enabled — описание опции звукового уведомления.
