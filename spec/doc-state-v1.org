#+title: Doc State v1 — Состояние документа (сохранение и восстановление)
#+author: Carriage Team
#+language: ru
#+options: toc:2 num:t
#+property: header-args :results silent

* Назначение
- Стандартизировать хранение и восстановление параметров Carriage в самом Org‑документе.
- Сделать поведение воспроизводимым: открыли документ — получили прежнюю Intent/Suite/модель/движок.
- Изменения через UI/команды — автоматически отражаются в документе.

* Модель хранения (источник истины в документе)
- Каноническое хранение — строки верхнего уровня:
  #+begin_example
  #+PROPERTY: CARRIAGE_MODE t
  #+PROPERTY: CARRIAGE_INTENT Code
  #+PROPERTY: CARRIAGE_SUITE udiff
  #+PROPERTY: CARRIAGE_MODEL_ID gptel:provider:model
  #+PROPERTY: CARRIAGE_ENGINE git
  #+PROPERTY: CARRIAGE_BRANCH_POLICY ephemeral
  #+PROPERTY: CARRIAGE_CTX_GPTEL t
  #+PROPERTY: CARRIAGE_CTX_DOC t
  #+PROPERTY: CARRIAGE_REPORT_POLICY on-error
  #+PROPERTY: CARRIAGE_STAGE_POLICY index
  #+end_example
- Обязательные ключи (v1):
  - CAR_MODE: t|nil — включать ли carriage-mode при открытии (auto-enable).
  - CAR_INTENT: Ask|Code|Hybrid.
  - CAR_SUITE: sre|aibo|udiff.
  - CAR_MODEL_ID: полный id backend[:provider]:model.
  - CAR_ENGINE: git|emacs|…
  - Для git: CAR_BRANCH_POLICY: in-place|wip|ephemeral.
- Дополнительные ключи (опционально):
  - CAR_CTX_GPTEL, CAR_CTX_DOC: t|nil — тумблеры контекста запроса.
  - CAR_REPORT_POLICY: on-error|always|never — политика автооткрытия отчёта.
  - CAR_STAGE_POLICY: index|none — политика индексации при применении.
  - CAR_ICONS, CAR_FLASH, CAR_AUDIO_NOTIFY: t|nil — визуальные/аудио‑настройки UI.
- Сворачивание: строки #+PROPERTY: CARRIAGE_* скрываются по умолчанию (org-fold/overlays); при наличии property drawer он также скрывается.

Канон хранения:
- Значения записываются и обновляются в строках:
  #+PROPERTY: CARRIAGE_* VALUE
- Заголовок «Carriage State» с property drawer поддерживается только для чтения (совместимость со старыми документами); запись всегда выполняется в #+PROPERTY.

* Жизненный цикл и интеграция
- Автовключение (global):
  - При включённом carriage-global-mode хук find-file читает CAR_MODE; если t и это Org в git‑проекте — включает carriage-mode.
- Включение carriage-mode:
  - Читает блок «Carriage State», восстанавливает Intent/Suite/модель/движок/политики.
  - Скрывает property drawer и обновляет UI (mode-line/header-line).
- Изменение параметров:
  - После команд:
    - carriage-toggle-intent
    - carriage-select-suite
    - carriage-select-model
    - carriage-select-apply-engine
    - carriage-toggle-include-gptel-context
    - carriage-toggle-include-doc-context
    - смены политики отчёта/стейджинга
  - Выполняется запись соответствующих ключей в property drawer (без навязчивого сохранения файла).
- Выключение carriage-mode:
  - Опционально записывает CAR_MODE=nil (без автосейва); решение о сохранении остаётся за пользователем.

* Норматив (поведение и границы)
- Безопасность:
  - Не используется eval‑локальных переменных; только декларативные свойства.
  - В batch/TRAMP поведение консервативное: без всплывающих окон/интерактива.
- Производительность:
  - Чтение/запись — через org‑API (org-entry-get/org-set-property); минимальные перемещения точки (save-excursion).
  - Сворачивание — org-fold-hide-drawer-or-block (или совместимый API).
- Идемпотентность:
  - «Прочитал → выставил → записал → перечитал» не меняет значений.
- Толерантность:
  - Отсутствующие ключи не ломают включение; используются дефолты Carriage.

* API (реализация в lisp/carriage-doc-state.el)
- carriage-doc-state-read (&optional buffer) → PLIST
  - Читает свойства из заголовка «Carriage State», fallback к #+PROPERTY.
- carriage-doc-state-write (PLIST|ALIST|KEYS &optional buffer) → t
  - Создаёт/обновляет заголовок и свойства. Принимает:
    - plist вида (:CAR_INTENT "Code" :CAR_SUITE "udiff" …) или
    - alist вида ((CAR_INTENT . "Code") …) или
    - ключевой список (KEY VALUE …).
- carriage-doc-state-restore (&optional buffer) → t
  - Читает документ и выставляет:
    - intent, suite, model/backend[:provider], apply engine (+policy).
    - toggles/context/report policy/stage policy — при наличии.
- carriage-doc-state-hide (&optional buffer) → t
  - Сворачивает property drawer у заголовка «Carriage State».
- carriage-doc-state-toggle-visibility () → t
  - Переключает видимость строк «#+PROPERTY: CARRIAGE_*» (скрыть/показать) в текущем буфере.
- carriage-doc-state-auto-enable () → nil
  - find-file‑хук: включает carriage-mode, если CAR_MODE=t и контекст валиден.
- carriage-doc-state-save-on-save (defcustom, default t)
  - Перед сохранением буфера автоматически пишет текущие значения в property drawer (before-save-hook; буферно-локально).
- carriage-doc-state-sync-on-change (defcustom, default t)
  - Синхронизирует свойства при изменении состояния командами режима (через advice; буферно-локально).
- carriage-doc-state-install-save-hook / carriage-doc-state-remove-save-hook
  - Явная установка/снятие хука сохранения для текущего буфера.

Встраивание:
- carriage-mode.el:
  - В carriage-mode--enable: после init-state вызвать …restore и …hide.
  - После перечисленных выше команд — :after‑advice для …write (обновление конкретных ключей).
- carriage-global-mode.el:
  - При enable — добавить find-file‑hook → carriage-doc-state-auto-enable.
- UI:
  - При смене модели/движка/интентов — force-mode-line-update; property drawer скрыт.

* Тесты (минимальная матрица)
- Создание блока:
  - В «чистом» Org при включении carriage-mode появился заголовок «Carriage State» с CAR_MODE=t; drawer свёрнут.
- Восстановление:
  - Редактируем свойства руками → включаем режим → значения переменных совпали.
- Автовключение:
  - При global‑режиме и CAR_MODE=t документ открывается с включённым carriage-mode; при nil — нет.
- Обновления:
  - После смены intent/suite/model/engine/toggles — соответствующие свойства изменены.
- Fallback:
  - При наличии #+PROPERTY: CARRIAGE_* restore сработал; первая запись перенесла значения в drawer.
- Batch:
  - В batch не возникает интерактивных запросов; запись/чтение — стабильны.

* Указатели
- Реализация: lisp/carriage-doc-state.el
- Спецификации:
  - ./project-overview-v1.org — карта исходников, размещение модуля.
  - ./ui-v1.org — сворачивание служебного блока, событийная модель UI.
  - ./testing-v1.org — тесты doc-state.
  - ./index.org — ссылка на этот документ.
