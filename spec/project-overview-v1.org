#+title: Обзор проекта Carriage-mode v1 — Структура и карта
#+author: Carriage Team
#+language: ru
#+options: toc:2 num:t
#+property: header-args :results silent

* Назначение
- Единый документ-«источник истины» о структуре проекта и карте исходников.
- Объединяет прежние документы:
  - Project Structure v1 — слои/каталоги/правила/загрузка/тесты/миграции.
  - Project Map v1 — обзор модулей (lisp/*) с ключевыми API и указатели на спецификации.
- Цель: чтобы новые части проекта появлялись в правильных местах и с понятными контрактами.

* Свод правил структурирования (источник истины)

** Слои и зависимости (направление сверху вниз запрещено)
- Core: errors → logging → utils → git
- Domain: parser → apply → report
- Mode/UI: ui → iteration → mode → entry (carriage.el)
- Engines: lisp/engines/* — зависят от logging/utils/git, не от UI
- Transports: lisp/transports/* — зависят только от errors/logging/utils; не зависят от UI
- Правила:
  - UI не импортируется из parser/apply.
  - Транспорт не модифицирует глобальные переменные Emacs.

** Директории
- lisp/ — исходники (ядро и модули):
  - carriage-*.el — ядро и домен: errors, logging, utils, git, parser, apply, iteration, ui, report, mode, entry.
  - engines/ — движки применения (реестр и реализации: git, emacs, magit и др.).
  - transports/ — адаптеры LLM/агентов (например, gptel, JSON-RPC), опционально.
  - ops/ — оп-модули (:op): один файл на формат; рядом публикуются фрагменты промптов. Suite собирает системный промпт из этих фрагментов.
  - carriage-intent-registry.el — реестр интентов (фрагменты промптов Intent; CTX → STRING).
  - carriage-suite.el — компоновщик Suite/Prompt Builder: собирает системный промпт из фрагментов ops и intent; публичная функция carriage-build-prompt (pure).
  - (удалено в v1.1) — DELIM для :op "create" больше не используется; санитайзер и парсер принимают «сырой» контент тела блока.
  - ui/ — доп. компоненты UI/виджеты (опционально).
- spec/ — спецификации (норматив и разъяснения).
  - prompt-profiles-v1.org — Intent/Suite и композиция промптов (один язык; i18n не применяется к промптам; замены/расширения через overrides/overlays).
  - extensibility-points-v1.org — точки расширения (ops, транспорты, UI) и правила сборки Suite.
  - testing-v1.org — план тестов (юниты/интеграция), включая проверки промпт-билдера.
- test/ — ERT и интеграционные фикстуры (git-репо).
- scripts/ — batch-скрипты (lint, compile-strict, checkdoc).
- examples/ — «golden» документы.
- .context/ — персистентное состояние проекта (например, ".context/carriage/carriage-state.el").

** Именование и provide
- Имя файла и feature: carriage-foo.el → (provide 'carriage-foo).
- Публичные API: carriage-foo-bar; внутренние: carriage--foo-bar.
- defcustom — в одном «владельце» слоя; остальные файлы — declare-variable при необходимости.
- Интерактивные команды — ;;;###autoload.

** Порядок загрузки
- carriage.el: require errors→(carriage-define-errors)→logging→utils→git→carriage-format-registry→carriage-intent-registry→carriage-suite→parser→apply→ops→mode.
- Транспорты подключаются через абстракцию (см. llm-transport-v1), не require-ятся по умолчанию.

** Безопасность
- Пути — только относительные внутри корня; TRAMP — запрещён (v1).
- Бинарные патчи — запрещены в v1 (см. spec/security-v1.org).

** Тестирование/CI
- Юнит: ERT на парсеры/апплаеры/утилиты.
- Интеграция: тестовый git-репозиторий.
- Моки транспорта (gptel-mock).
- CI: byte-compile (строго), checkdoc, package-lint, ert.

* Миграции и дополнения

** Миграция v1→v1.1 (без ломки)
- Устранить дубли defcustom/defvar.
- Синхронизировать предупреждения SRE_W_*.
- Вынести транспорты в lisp/transports/.

** Дополнения v1.1
- Новые спецификации в каталоге spec/:
  - context-integration-v1.org — единая модель включения контекста (gptel + блоки документа).
  - keyspec-v1.org — спецификация централизованной модели биндингов и генераторов which-key/transient/hydra.
  - i18n-v1.org — слой локализации (переводы ru/en, ключи для UI/which-key/transient).

** Дополнения v1.2 — Ключи и глобальный режим
- Новые модули (lisp/):
  - carriage-keys.el — применение keyspec к картам, генерация which-key/transient, линтер коллизий.
  - carriage-global-mode.el — глобальный минор-режим для префикса C-c e (контекст global).
- Перенос ответственности:
  - В carriage-ui.el не должно быть defvar/define-key для основной карты режима; все биндинги — через keyspec и модули выше.
- Проектный буфер:
  - Реализация команды carriage-open-buffer (управление уникальностью на проект, маркировка «эфемерности», хук выхода).

* Карта исходников (lisp/*)

** Core (базовые подсистемы)
- lisp/carriage-errors.el
  - Назначение: таблица ошибок и define-error.
  - Ключевые: carriage-define-errors, carriage-error-symbol, carriage-error-message.
- lisp/carriage-logging.el
  - Журналы (*carriage-log*, *carriage-traffic*), показ в сайд-окнах, спец-режим carriage-aux-mode.
  - Ключевые: carriage-log, carriage-traffic-log, carriage-show-log, carriage-show-traffic.
- lisp/carriage-utils.el
  - Утилиты: корень проекта, нормализация путей, вызовы git (sync), I/O файлов, генерация DELIM.
  - Ключевые: carriage-project-root, carriage-normalize-path, carriage--call-git, carriage-generate-delim.
- lisp/carriage-git.el
  - Git-хелперы (sync + async) и веточные политики (WIP/ephemeral).
  - Ключевые (async): carriage-git-ensure-repo-async, carriage-git-checkout-wip-async,
    carriage-git-create-ephemeral-branch-async, carriage-git-switch-branch-async,
    carriage-git-delete-branch-async, carriage-git-branches-diff-empty-async.
  - Ключевые (sync): carriage-git-add, carriage-git-commit, carriage-git-mv, carriage-git-rm, carriage-git-reset-soft.

** Реестры и билдеры
- lisp/carriage-format-registry.el
  - Реестр парсеров/апплаеров: (:op,:version) → (:parse :dry-run :apply :prompt-fragment).
  - Ключевые: carriage-format-register, carriage-format-get, carriage-format-ops.
- lisp/carriage-intent-registry.el
  - Реестр фрагментов Intent (Ask|Code|Hybrid).
  - Ключевые: carriage-intent-register, carriage-intent-get, carriage-intent-known.
- lisp/carriage-llm-registry.el
  - Реестр бэкендов/моделей LLM; кандидаты выбора; нормализация id.
  - Ключевые: carriage-llm-register-backend, carriage-llm-available-models,
    carriage-llm-candidates, carriage-llm-default-candidate, carriage-llm-make-full-id.
- lisp/carriage-suite.el
  - Suite builder: композиция системного промпта из фрагментов ops и intent, белые списки :ops-allowed.
  - Ключевые: carriage-suite-ops, carriage-suite-ids, carriage-build-prompt.

** Форматы (ops/*) — парсеры/апплаеры
- lisp/ops/carriage-op-sre.el
  - SRE v1: пары begin_from/begin_to (+ #+pair). Dry-run/симуляция, мини-диффы, apply.
  - Ключевые: carriage-parse-sre, carriage-dry-run-sre, carriage-apply-sre.
- lisp/ops/carriage-op-aibo.el
  - AIBO v1: literal-only S/R, запрет :match; делегирует в SRE-ядро.
  - Ключевые: carriage-parse-aibo, carriage-dry-run-aibo, carriage-apply-aibo.
- lisp/ops/carriage-op-patch.el
  - Unified diff v1 (один файл), валидация :strip, binary/rename/copy guards.
  - Ключевые: carriage-parse-diff (+ вспом. валидаторы).
- lisp/ops/carriage-op-file.el
  - File ops: create/replace/delete/rename (парсер, dry-run, apply).
  - Ключевые: carriage-parse-create, carriage-parse-delete, carriage-parse-rename, carriage-parse-replace,
    carriage-dry-run-create, carriage-dry-run-replace, carriage-apply-create, carriage-apply-replace, carriage-apply-delete, carriage-apply-rename.
- lisp/carriage-sre-core.el
  - Общие хелперы SRE (в т.ч. загрузка carriage-sre-delim).
- (Удалено в v1.1) — модуль перепрошивки DELIM не требуется: :op create использует «сырой» контент тела блока.

** Пайплайн применения
- lisp/carriage-apply.el
  - Порядок и группировка план-элементов; dry-run/apply отчёты; асинхронный FSM, веточные политики git.
  - Ключевые:
    - Сортировка и отчёты: carriage-dry-run-plan, carriage-apply-plan.
    - Async FSM: carriage-apply-plan-async (+ внутренние carriage--apply-…).
    - Движок → рядок отчёта: carriage--engine-row.
- lisp/engines/carriage-apply-engine.el
  - Реестр движков, выбор активного, диспетчеризация :dry-run/:apply с проверкой capabilities.
  - Ключевые: carriage-register-apply-engine, carriage-apply-engine, carriage-apply-engine-dispatch,
    carriage-select-apply-engine.
- lisp/engines/carriage-engine-git.el
  - Движок 'git: async процессы (git apply/--check, add/rm/mv), таймауты/abort.
  - Ключевые: carriage-engine-git-dry-run, carriage-engine-git-apply, carriage-engine-git-abort.
- lisp/engines/carriage-engine-emacs.el
  - Движок 'emacs: локальные операции (create/delete/rename/sre/aibo); patch в v1 не поддерживается (capabilities).
  - Ключевые: carriage-engine-emacs-dry-run, carriage-engine-emacs-apply, carriage-engine-emacs-capabilities.

** Транспорт LLM (streaming)
- lisp/transports/carriage-transport.el
  - Диспетчер транспорта: begin/streaming/complete, ленивые подгрузки адаптеров.
  - Ключевые: carriage-transport-begin, carriage-transport-streaming, carriage-transport-complete,
    carriage-transport-dispatch.
- lisp/transports/carriage-transport-gptel.el
  - Адаптер к gptel: потоковые события, reasoning, abort, вставка чанков через UI API.
  - Ключевые: carriage-transport-gptel-dispatch (+ внутренний классификатор событий).
- lisp/transports/carriage-transport-echo.el
  - Echo-демо адаптер (dev): имитация стрима; удобен для отладки.

** UI/Mode/Report/Context
- lisp/carriage-ui.el
  - Header-line (project › buffer › outline), mode-line (иконки/кнопки/спиннер), эффекты (flash/звук).
  - Ключевые: carriage-ui-set-state, carriage-ui--modeline, carriage-ui--header-line,
    carriage-ui--flash-last-iteration-patches.
- lisp/carriage-mode.el
  - Минор-режим, публичные команды, интеграция всего: отправка/приём/применение, тумблеры, preloader.
  - Ключевые команды: carriage-mode, carriage-send-buffer, carriage-send-subtree,
    carriage-dry-run-at-point, carriage-apply-at-point-or-region, carriage-apply-last-iteration,
    carriage-select-suite, carriage-select-model, carriage-select-backend, carriage-select-apply-engine,
    carriage-commit-changes, carriage-commit-last-iteration, carriage-abort-current, carriage-open-buffer.
- lisp/carriage-task.el
  - Создание нумерованного документа задачи из заголовка TODO.org (org/N-<slug>.org), взаимные ссылки с TODO.
  - Ключевые: carriage-create-task-doc; интеграция клавиши C-c e n через keyspec (только в org).
- lisp/carriage-keyspec.el
  - Централизованная модель биндингов по контекстам; генерация transient/which-key.
  - Ключевые: carriage-keys-apply-known-keymaps, carriage-keys-open-menu, carriage-keys-lint-collisions.
- lisp/carriage-global-mode.el
  - Глобальный префикс C-c e вне carriage-mode; связывает меню/префикс с контекстом global.
- lisp/carriage-report.el
  - Буфер отчёта (org-table), кнопки действий, Ediff/preview.
  - Ключевые: carriage-report-open, carriage-report-render, carriage-report-apply-at-point,
    carriage-report-show-diff-at-point, carriage-report-ediff-at-point.
- lisp/carriage-context.el
  - Сбор и форматирование контекста (gptel-context + #+begin_context).
  - Ключевые: carriage-context-collect, carriage-context-format, carriage-context-count.
- lisp/carriage-i18n.el
  - Слой локализации (ru/en) для UI/which-key/transient.
  - Ключевые: carriage-i18n, carriage-i18n-set-locale.
- lisp/carriage-doc-state.el
  - Хранение/восстановление состояния документа (property drawer «Carriage State», #+PROPERTY fallback).
  - Ключевые: carriage-doc-state-read, carriage-doc-state-write, carriage-doc-state-restore,
    carriage-doc-state-hide, carriage-doc-state-auto-enable.
  - Спецификация: spec/doc-state-v1.org.
- lisp/carriage-block-fold.el
  - Переиспользуемое сворачивание begin_<kind> блоков поверх оверлеев (без org-fold):
    авто‑раскрытие при входе курсора и авто‑скрытие при выходе; компактная строка‑заглушка (before-string).
  - Ключевые: carriage-block-fold-ensure-overlay, carriage-block-fold-reveal, carriage-block-fold-hide,
    carriage-block-fold-install-cursor-watch, carriage-block-fold-install-change-watch.
  - Используется из: carriage-doc-state.el (kind 'carriage).
- lisp/carriage-iteration.el
  - Маркировка/чтение «последней итерации» (inline marker + text properties).
  - Ключевые: carriage-mark-last-iteration, carriage-current-iteration-id, carriage-begin-iteration.
- lisp/carriage-announce.el
  - Дружественные сообщения об успешном применении (hook поверх отчёта).
- lisp/carriage-parser.el
  - Диспетчер парсинга блока под точкой/в регионе; ленивые подгрузки ops-модулей.
  - Ключевые: carriage-parse-block-at-point, carriage-parse-blocks-in-region, carriage-parse.

** Входная точка
- lisp/carriage.el
  - Entry point; инициализирует ошибки/пути, подключает ключевые подсистемы и регистры; добавляет ops/transports/engines в load-path.
  - Ключевое: (carriage-define-errors), require основных модулей.

* Указатели на спецификации (spec/* — основные)
- spec/index.org — индекс спецификаций и FREEZE (лимиты).
- spec/apply-engines-v1.org — абстракция движков применения.
- spec/apply-pipeline-v1.org — конвейер dry-run/подтверждение/apply.
- spec/patch-unified-diff-v1.org — unified diff (v1).
- spec/sre-v1.org — SRE (begin_from/begin_to).
- spec/aibo-v1.org — AIBO (literal-only S/R).
- spec/file-ops-v1.org — create/delete/rename.
- spec/security-v1.org — политика безопасности (пути/TRAMP/EOL).
- spec/errors-v1.org — коды ошибок и таблицы.
- spec/ui-v1.org — header-line/mode-line/меню/отчёты.
- spec/llm-transport-v1.org — абстракция транспорта (gptel-адаптер).
- spec/context-integration-v1.org — контекст (gptel + документальные блоки).
- spec/keyspec-v1.org — централизованная модель клавиш.
- spec/testing-v1.org — план тестов (юниты/интеграция), голден-файлы.
- spec/compliance-checklist-v1.org — чек-лист соответствия.

* Точки расширения (как найти место для доработки)
- Новый формат (:op): создать lisp/ops/carriage-op-<op>.el, зарегистрировать parse/dry-run/apply, добавить prompt-fragment; обновить suite overlays при необходимости.
- Новый движок применения: lisp/engines/carriage-engine-<name>.el; зарегистрировать через carriage-register-apply-engine; указать capabilities.
- Новый транспорт: lisp/transports/carriage-transport-<backend>.el; предоставить entry-point carriage-transport-<backend>-dispatch.
- Новые действия/клавиши: добавить запись в carriage-keyspec (:id :cmd :keys :contexts …); i18n — через carriage-i18n.el.
- Новые UI компоненты: расширять carriage-ui.el (header-line/modeline) или дочерние спец-буферы; соблюдать буферную локальность и i18n-ключи.

* Примечания по навигации кода
- Быстрый поиск «источника истины»: сначала смотреть спецификацию в spec/*, затем реализацию в lisp/*.
- Для основного сценария dry-run/apply:
  1) carriage-parser.el → (parse блоков) → план
  2) carriage-apply.el → (dry-run/async FSM) → отчёт
  3) engines/* → git/emacs шаги
  4) report/ui → визуализация и действия
- Для стриминга LLM:
  1) carriage-mode.el (send-buffer/subtree) → carriage-transport-begin → carriage-transport-*-dispatch
  2) carriage-transport-*.el → события (text/reasoning/done/abort)
  3) carriage-ui.el → вставка чанков, спиннер, финализация/flash/звук.
