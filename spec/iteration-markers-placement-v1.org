#+title: Iteration Markers Placement v1
#+language: ru
#+options: toc:2 num:t

* Цель
Определить, как визуально и логически помечать «последнюю итерацию» в буфере без привязки к заголовкам Org.

* Термины
- «ID итерации» — строковый идентификатор (hex), присваиваемый ответу.
- «Inline маркер» — строка именно перед ответом:
  #+CARRIAGE_ITERATION_ID: <id>

* Источник истины
- Предпочтительно: отбор блоков «последней итерации» по текстовым свойствам
  на строках #+begin_patch: carriage-iteration-id == <id>.
- Inline маркер — визуальный якорь и инструмент восстановления; когда свойства
  отсутствуют (например, блоки были вставлены вручную), применяется fallback:
  все блоки между ПОСЛЕДНЕЙ строкой вида
    #+CARRIAGE_ITERATION_ID: <id>
  и следующей такой строкой ниже (либо до конца буфера, если следующей нет),
  считаются принадлежащими «последней итерации».

* Правила размещения
- По умолчанию ('inline): вставлять перед ответом пустую строку и затем
  #+CARRIAGE_ITERATION_ID: <id>
- Альтернатива ('property): использовать только «#+PROPERTY: CARRIAGE_ITERATION_ID <id>»
  (совместимость), без inline-маркера.

* Чтение ID
Порядок:
1) PROPERTY: #+PROPERTY: CARRIAGE_ITERATION_ID <id>
2) INLINE:   #+CARRIAGE_ITERATION_ID: <id>

* Маркировка блоков
- После окончания стриминга ответный регион помечается свойствами
  carriage-iteration-id на строках #+begin_patch.
- Inline маркер вставляется только при конфигурации 'inline.

* Строгость
- Строгий сборщик использует только свойства и не падает на отсутствие inline/PROPERTY,
  но команда apply-all строго откажет, если не найдено ни одного помеченного блока.

* Диагностика
- При пустом наборе для strict-команды выводится сообщение с числом всех блоков и помеченных,
  подсказка — «Сначала отметьте последнюю итерацию».
